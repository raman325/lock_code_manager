#!/usr/bin/env bash

# Script setup
set -e
cd "$(dirname "$0")/.."

get_virtual_release_tag() {
  python3 - <<'PY' "https://api.github.com/repos/twrecked/hass-virtual/releases/latest"
import json
import sys
import urllib.request

url = sys.argv[1]
with urllib.request.urlopen(url) as resp:
    data = json.load(resp)
print(data["tag_name"])
PY
}

ensure_link() {
    local target="$1"
    local link="$2"
    local backup
    local existing

    mkdir -p "$(dirname "$link")"

    if [ -L "$link" ]; then
        existing="$(readlink "$link")"
        if [ "$existing" = "$target" ]; then
            return
        fi
        rm "$link"
    elif [ -e "$link" ]; then
        backup="${link}.bak.$(date +%Y%m%d%H%M%S)"
        mv "$link" "$backup"
    fi

    ln -s "$target" "$link"
}

# Script start
if [ -n "$DEVCONTAINER" ]; then
  echo "Use scripts/setup-devcontainer when running inside a devcontainer." >&2
  exit 1
fi

if [ ! -n "$VIRTUAL_ENV" ];then
  python3.13 -m venv venv
  source venv/bin/activate
fi

pip install --upgrade uv
uv pip install -r requirements_dev.txt


pre-commit install
yarn install

# Setup directories for HA config
mkdir -p "${PWD}/.ha/custom_components"

# Copy yaml config files to .ha (makes .ha self-contained for volume mounting)
for yaml_file in "${PWD}"/dev/*.yaml; do
    if [ -f "$yaml_file" ]; then
        cp "$yaml_file" "${PWD}/.ha/"
    fi
done

# Link the component being developed
ensure_link "${PWD}/custom_components/lock_code_manager" "${PWD}/.ha/custom_components/lock_code_manager"

# Download and extract Virtual component if not already present
if [[ ! -d "${PWD}/.ha/custom_components/virtual" ]]; then
    virtual_tag="$(get_virtual_release_tag)"
    curl -L -o virtual.zip "https://github.com/twrecked/hass-virtual/archive/refs/tags/${virtual_tag}.zip"
    unzip -j virtual.zip "*/custom_components/virtual/*" -d "${PWD}/.ha/custom_components/virtual/"

    rm virtual.zip
fi

hass --config "${PWD}/.ha" --script ensure_config
