#!/usr/bin/env bash

# Script setup
set -e
cd "$(dirname "$0")/.."

export DEVCONTAINER=1

get_virtual_release_tag() {
    python3 - <<'PY' "https://api.github.com/repos/twrecked/hass-virtual/releases/latest"
import json
import sys
import urllib.request

url = sys.argv[1]
with urllib.request.urlopen(url) as resp:
    data = json.load(resp)
print(data["tag_name"])
PY
}

ensure_link() {
    local target="$1"
    local link="$2"
    local backup
    local existing

    mkdir -p "$(dirname "$link")"

    if [ -L "$link" ]; then
        existing="$(readlink "$link")"
        if [ "$existing" = "$target" ]; then
            return
        fi
        rm "$link"
    elif [ -e "$link" ]; then
        backup="${link}.bak.$(date +%Y%m%d%H%M%S)"
        mv "$link" "$backup"
    fi

    ln -s "$target" "$link"
}

# Install dependencies into the container's system Python environment.
if command -v dpkg >/dev/null 2>&1; then
    if ! dpkg -s libudev-dev >/dev/null 2>&1; then
        sudo apt-get update
        sudo apt-get install -y libudev-dev
    fi
fi

python3 -m pip install --upgrade uv
uv pip install --system -r requirements_dev.txt

if ! python3 - <<'PY'
try:
    import aiousbwatcher  # noqa: F401
except ImportError:
    raise SystemExit(1)
PY
then
    python3 -m pip install aiousbwatcher==1.1.1
fi

pre-commit install
yarn install

# Setup directories for HA and linking
ensure_link "${PWD}/dev/configuration.yaml" "${PWD}/.ha/configuration.yaml"
ensure_link "${PWD}/dev/virtual.yaml" "${PWD}/.ha/virtual.yaml"
ensure_link "${PWD}/custom_components/lock_code_manager" "${PWD}/.ha/custom_components/lock_code_manager"

# Download and extract Virtual component if not already present
if [[ ! -d "${PWD}/.ha/custom_components/virtual" ]]; then
    virtual_tag="$(get_virtual_release_tag)"
    curl -L -o virtual.zip "https://github.com/twrecked/hass-virtual/archive/refs/tags/${virtual_tag}.zip"
    unzip -j virtual.zip "*/custom_components/virtual/*" -d "${PWD}/.ha/custom_components/virtual/"

    rm virtual.zip
fi

hass --config "${PWD}/.ha" --script ensure_config
